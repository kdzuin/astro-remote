#include <M5Unified.h>
#include "screens/video_screen.h"
#include "ble_device.h"

VideoScreen videoScreen;

void setup()
{
    M5.begin();
    M5.Display.setRotation(1);
    M5.Display.setTextSize(2);
    Serial.begin(115200);

    // Initialize BLE and try to connect to last camera
    BLEDeviceManager::init();
    if (BLEDeviceManager::isPaired())
    {
        Serial.println("Connecting to last camera...");
        if (BLEDeviceManager::connectToSavedDevice())
        {
            Serial.println("Connected to last camera successfully");
        }
    }

    // Initial draw
    videoScreen.draw();
}

void loop()
{
    M5.update();

    // Handle power button to quit test
    if (M5.BtnPWR.wasClicked())
    {
        M5.Display.fillScreen(BLACK);
        M5.Display.setTextColor(WHITE);
        M5.Display.setTextSize(2);

        const char *text = "Test Complete";
        int textWidth = M5.Display.textWidth(text);
        int x = (M5.Display.width() - textWidth) / 2;
        int y = M5.Display.height() / 2;
        M5.Display.drawString(text, x, y);

        delay(1000);
        ESP.restart();
    }

    // Update BLE and video screen
    BLEDeviceManager::update();
    videoScreen.update();
    delay(10);
}
